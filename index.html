<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2d7a2d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TT Tracker</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <style>
    /* === RESET + ROOT VARIABLES === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #2d7a2d;
      --primary-dark: #1e5c1e;
      --primary-light: #4caf50;
      --accent: #ff6f00;
      --bg: #f0f4f0;
      --surface: #ffffff;
      --surface-2: #f9faf9;
      --border: #e0e8e0;
      --text: #1a2e1a;
      --text-muted: #6b7c6b;
      --win: #2e7d32;
      --loss: #c62828;
      --danger: #d32f2f;
      --nav-height: 64px;
      --header-height: 56px;
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.10);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.14);
    }

    [data-theme="dark"] {
      --bg: #1a1d1a;
      --surface: #242824;
      --surface-2: #2a2e2a;
      --border: #3a3e3a;
      --text: #e0e4e0;
      --text-muted: #8a9a8a;
      --win: #4caf50;
      --loss: #ef5350;
      --danger: #ef5350;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
    }

    [data-theme="dark"] .loading-overlay {
      background: rgba(26,29,26,0.85);
    }

    [data-theme="dark"] .form-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%238a9a8a' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
    }

    [data-theme="dark"] .form-badge--win  { background: rgba(76,175,80,0.2); }
    [data-theme="dark"] .form-badge--loss { background: rgba(239,83,80,0.18); }
    [data-theme="dark"] .form-badge--draw { background: rgba(138,154,138,0.2); }

    [data-theme="dark"] .streak-badge--win  { background: rgba(76,175,80,0.18); }
    [data-theme="dark"] .streak-badge--loss { background: rgba(239,83,80,0.15); }

    [data-theme="dark"] .result-preview--winning { background: rgba(76,175,80,0.12); }

    [data-theme="dark"] .toast { background: #2a2e2a; }

    [data-theme="dark"] .error { background: rgba(239,83,80,0.15); color: #ef5350; }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 15px;
      color: var(--text);
      background: var(--bg);
      -webkit-tap-highlight-color: transparent;
    }

    /* === APP SHELL === */
    .app-wrapper {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg);
      position: relative;
    }

    /* === HEADER === */
    .app-header {
      height: var(--header-height);
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: relative;
      z-index: 10;
    }

    .app-header__title {
      color: #fff;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    /* === TAB CONTENT === */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding-bottom: calc(var(--nav-height) + 12px);
    }

    .tab-panel {
      display: none;
      min-height: 100%;
      padding: 12px 12px 0;
      animation: fadeIn 0.18s ease;
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* === BOTTOM NAV === */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      height: var(--nav-height);
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: stretch;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    .bottom-nav__item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      padding: 8px 4px;
      transition: color 0.15s;
      position: relative;
    }

    .bottom-nav__item.active {
      color: var(--primary);
    }

    .bottom-nav__item.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 20%;
      right: 20%;
      height: 3px;
      background: var(--primary);
      border-radius: 0 0 3px 3px;
    }

    .bottom-nav__icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bottom-nav__icon svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
    }

    .bottom-nav__label {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.2px;
    }

    /* === SECTIONS === */
    .section {
      margin-bottom: 16px;
    }

    .section__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .section__title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
    }

    .section__action {
      font-size: 13px;
      color: var(--primary);
      font-weight: 500;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 0;
    }

    /* === CARDS === */
    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .card--padded {
      padding: 16px;
    }

    /* === WELCOME CARD === */
    .welcome-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 16px;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .welcome-card__text h2 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .welcome-card__text p {
      font-size: 13px;
      opacity: 0.85;
    }

    .welcome-card__btn {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: var(--radius-full);
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      transition: background 0.15s;
    }

    .welcome-card__btn:active {
      background: rgba(255,255,255,0.35);
    }

    /* === MATCH CARD === */
    .match-card {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      margin-bottom: 8px;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      transition: transform 0.1s ease;
    }

    .match-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .match-card__players {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .match-card__player {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 90px;
    }

    .match-card__player--winner {
      font-weight: 700;
      color: var(--win);
    }

    .match-card__vs {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      opacity: 0.5;
      flex-shrink: 0;
    }

    .match-card__score {
      font-size: 22px;
      font-weight: 800;
      color: var(--primary);
      min-width: 44px;
      text-align: right;
      letter-spacing: -1px;
      flex-shrink: 0;
    }

    .match-card__sets {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .match-card__meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .match-card__time {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.65;
    }

    .match-card__note {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* === PLAYER ROW === */
    .player-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--surface);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.12s;
      -webkit-user-select: none;
      user-select: none;
    }

    .player-row:active {
      transform: scale(0.98);
    }

    .player-row__info {
      flex: 1;
    }

    .player-row__name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .player-row__record {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .player-row__chevron {
      color: var(--text-muted);
      opacity: 0.35;
      font-size: 22px;
      font-weight: 300;
    }

    /* === AVATAR === */
    .avatar {
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
      text-transform: uppercase;
    }

    .avatar--sm { width: 32px; height: 32px; font-size: 13px; }
    .avatar--md { width: 44px; height: 44px; font-size: 18px; }
    .avatar--lg { width: 60px; height: 60px; font-size: 24px; }

    /* === FORM COMPONENTS === */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 15px;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      appearance: none;
      -webkit-appearance: none;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .form-input:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(45,122,45,0.12);
    }

    .form-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%236b7c6b' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* === PLAYER SELECT PAIR === */
    .player-select-pair {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
    }

    .vs-divider {
      font-size: 13px;
      font-weight: 800;
      color: var(--text-muted);
      text-align: center;
      padding: 0 2px;
    }

    /* === SET ROWS === */
    .sets-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .set-row {
      display: grid;
      grid-template-columns: 38px 1fr auto 1fr auto;
      align-items: center;
      gap: 6px;
      background: var(--surface-2);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      border: 1px solid var(--border);
    }

    .set-row__label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .set-row__score {
      width: 100%;
      padding: 10px 6px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      color: var(--text);
      background: var(--surface);
      outline: none;
      transition: border-color 0.15s;
      min-width: 0;
    }

    .set-row__score:focus {
      border-color: var(--primary);
    }

    .set-row__sep {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-muted);
      text-align: center;
    }

    .set-row__remove {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: none;
      border: 1.5px solid var(--border);
      color: var(--text-muted);
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
      flex-shrink: 0;
    }

    .set-row__remove:active {
      background: var(--danger);
      color: #fff;
      border-color: var(--danger);
    }

    .set-row__remove:disabled {
      opacity: 0.2;
      cursor: not-allowed;
    }

    /* === RESULT PREVIEW === */
    .result-preview {
      border-radius: var(--radius-md);
      padding: 14px 16px;
      text-align: center;
      margin: 4px 0 12px;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .result-preview--neutral {
      background: var(--surface-2);
      border-color: var(--border);
    }

    .result-preview--winning {
      background: rgba(46,125,50,0.08);
      border-color: var(--win);
    }

    .result-preview__label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .result-preview__text {
      font-size: 17px;
      font-weight: 700;
      color: var(--text);
    }

    .result-preview--winning .result-preview__text {
      color: var(--win);
    }

    /* === STATS COMPONENTS === */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 14px;
      text-align: center;
      box-shadow: var(--shadow-sm);
    }

    .stat-card__value {
      font-size: 26px;
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-card__label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    /* === LEADERBOARD === */
    .leaderboard {
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .leaderboard__row {
      display: grid;
      grid-template-columns: 28px 1fr auto auto;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s;
    }

    .leaderboard__row:last-child {
      border-bottom: none;
    }

    .leaderboard__row:active {
      background: var(--surface-2);
    }

    .leaderboard__rank {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-muted);
      text-align: center;
    }

    .leaderboard__rank--gold   { color: #f9a825; }
    .leaderboard__rank--silver { color: #78909c; }
    .leaderboard__rank--bronze { color: #8d6e63; }

    .leaderboard__name {
      font-size: 15px;
      font-weight: 600;
    }

    .leaderboard__record {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
    }

    .leaderboard__winrate {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
      min-width: 44px;
      text-align: right;
    }

    /* === FORM BADGES === */
    .form-badges {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .form-badge {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 800;
    }

    .form-badge--win  { background: rgba(46,125,50,0.14); color: var(--win); }
    .form-badge--loss { background: rgba(198,40,40,0.10); color: var(--loss); }
    .form-badge--draw { background: rgba(107,124,107,0.14); color: var(--text-muted); }

    /* === H2H === */
    .h2h-section {
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .h2h-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }

    .h2h-row:last-child { border-bottom: none; }

    .h2h-row__name   { font-size: 14px; font-weight: 500; }
    .h2h-row__record { font-size: 13px; font-weight: 700; color: var(--primary); }

    /* === DATE GROUP === */
    .date-group__header {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      padding: 8px 2px 6px;
    }

    /* === BUTTONS === */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: none;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      padding: 12px 20px;
      transition: transform 0.1s, opacity 0.15s;
      -webkit-user-select: none;
      user-select: none;
    }

    .btn:active { transform: scale(0.97); }

    .btn--primary {
      background: var(--primary);
      color: #fff;
      width: 100%;
      padding: 14px;
      font-size: 16px;
      box-shadow: 0 3px 10px rgba(45,122,45,0.28);
    }

    .btn--primary:active { background: var(--primary-dark); }

    .btn--secondary {
      background: transparent;
      color: var(--primary);
      border: 1.5px solid var(--primary);
      width: 100%;
    }

    .btn--danger {
      background: var(--danger);
      color: #fff;
      width: 100%;
    }

    /* === MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      width: 100%;
      max-width: 480px;
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal__handle {
      width: 36px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 10px auto 4px;
      flex-shrink: 0;
    }

    .modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .modal__title {
      font-size: 17px;
      font-weight: 700;
    }

    .modal__close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .modal__body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .modal__footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      flex-shrink: 0;
    }

    /* === TOAST === */
    #toast-container {
      position: fixed;
      bottom: calc(var(--nav-height) + 12px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 300;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      gap: 8px;
      width: 90%;
      max-width: 420px;
      pointer-events: none;
    }

    .toast {
      background: #333;
      color: #fff;
      border-radius: var(--radius-md);
      padding: 12px 18px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.25s ease-out;
      width: 100%;
      text-align: center;
    }

    .toast--success { background: #2e7d32; }
    .toast--error   { background: var(--danger); }
    .toast--info    { background: var(--primary); }

    .toast.removing {
      animation: fadeDown 0.3s ease-in forwards;
    }

    @keyframes slideUp {
      from { transform: translateY(16px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeDown {
      from { transform: translateY(0); opacity: 1; }
      to   { transform: translateY(8px); opacity: 0; }
    }

    /* === LOADING SPINNER === */
    .loading-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(240,244,240,0.8);
      z-index: 50;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* === EMPTY STATE === */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      text-align: center;
    }

    .empty-state__icon  { font-size: 44px; margin-bottom: 12px; opacity: 0.55; }
    .empty-state__title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
    .empty-state__text  { font-size: 14px; color: var(--text-muted); line-height: 1.5; }

    /* === STREAK BADGE === */
    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 700;
    }

    .streak-badge--win  { background: rgba(46,125,50,0.12); color: var(--win); }
    .streak-badge--loss { background: rgba(198,40,40,0.10); color: var(--loss); }

    /* === PLAYER DETAIL === */
    .player-detail__header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .player-detail__name    { font-size: 22px; font-weight: 700; }
    .player-detail__matches { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

    /* === UTILITY === */
    .mt-sm { margin-top: 8px; }
    .mt-md { margin-top: 16px; }
    .mt-lg { margin-top: 24px; }
    .text-muted  { color: var(--text-muted); }
    .text-sm     { font-size: 13px; }
    .text-center { text-align: center; }

    /* Score inputs: no spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type=number] { -moz-appearance: textfield; }

    /* === RESPONSIVE === */
    @media (min-width: 480px) {
      body { background: #c8dcc8; }
      .app-wrapper { box-shadow: var(--shadow-lg); }
    }
    @media (min-width: 480px) {
      [data-theme="dark"] body { background: #121412; }
    }

    /* === THEME TOGGLE === */
    .theme-toggle {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      padding: 0;
      flex-shrink: 0;
      transition: background 0.15s;
    }
    .theme-toggle:active { background: rgba(255,255,255,0.3); }

    /* === OFFLINE BANNER === */
    .offline-banner {
      display: none;
      background: var(--accent);
      color: #fff;
      text-align: center;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .offline-banner.active { display: block; }

    /* === SYNC BADGE === */
    .sync-badge {
      display: none;
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      line-height: 18px;
      text-align: center;
    }
    .sync-badge.active { display: flex; }
  </style>
  <script>
    // Apply theme immediately to prevent flash of wrong theme
    (function() {
      var saved = localStorage.getItem('theme');
      var theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    })();
  </script>
</head>
<body>

<div class="app-wrapper">

  <!-- Header -->
  <header class="app-header">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="app-header__title" style="position:relative">üèì TT Tracker<span class="sync-badge" id="sync-badge">0</span></div>
      <span id="version-badge" style="font-size:10px;color:rgba(255,255,255,0.5);font-weight:400;display:none"></span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="theme-toggle" id="lang-toggle-btn" aria-label="Toggle language" style="font-size:12px;font-weight:700">EN</button>
      <button class="theme-toggle" id="export-btn" aria-label="Export data" title="Export data">&#8615;</button>
      <button class="theme-toggle" id="theme-toggle-btn" aria-label="Toggle dark mode">üåô</button>
      <button id="users-btn" aria-label="Manage users" style="display:none;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:50%;width:32px;height:32px;font-size:16px;cursor:pointer;padding:0;line-height:1">&#9881;</button>
      <form method="POST" action="/logout" style="margin:0">
        <button type="submit" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:20px;padding:6px 14px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Sign out</button>
      </form>
    </div>
  </header>

  <!-- Offline banner -->
  <div class="offline-banner" id="offline-banner"></div>

  <!-- Loading overlay -->
  <div class="loading-overlay active" id="loading-overlay"><div class="loading-spinner"></div></div>

  <!-- Tab Content -->
  <main class="tab-content">

    <!-- TAB: Home -->
    <section class="tab-panel active" id="tab-home">
      <div id="home-welcome"></div>
      <div id="home-recent-matches"></div>
      <div id="home-top-players"></div>
    </section>

    <!-- TAB: New Match -->
    <section class="tab-panel" id="tab-new-match">
      <div class="card card--padded">
        <div class="form-group">
          <label class="form-label">Players</label>
          <div class="player-select-pair">
            <select class="form-select" id="player1-select" aria-label="Player 1"></select>
            <div class="vs-divider">VS</div>
            <select class="form-select" id="player2-select" aria-label="Player 2"></select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Sets</label>
          <div class="sets-container" id="sets-container"></div>
          <button class="btn btn--secondary mt-sm" id="add-set-btn">+ Add Set</button>
        </div>
        <div class="result-preview result-preview--neutral" id="result-preview">
          <div class="result-preview__label">Result</div>
          <div class="result-preview__text" id="result-preview-text">Select players &amp; enter scores</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="match-note">Note (optional)</label>
          <input type="text" class="form-input" id="match-note" placeholder="e.g. Friendly game, tournament...">
        </div>
        <button class="btn btn--primary" id="save-match-btn">Save Match</button>
      </div>
    </section>

    <!-- TAB: Players -->
    <section class="tab-panel" id="tab-players">
      <div class="section">
        <button class="btn btn--primary" id="add-player-btn">+ Add Player</button>
      </div>
      <div id="players-list"></div>
    </section>

    <!-- TAB: History -->
    <section class="tab-panel" id="tab-history">
      <div class="section">
        <select class="form-select" id="history-filter-select"></select>
      </div>
      <div id="history-list"></div>
    </section>

    <!-- TAB: Stats -->
    <section class="tab-panel" id="tab-stats">
      <div class="section">
        <select class="form-select" id="stats-filter-select"></select>
      </div>
      <div id="leaderboard-container"></div>
      <div id="player-stats-container"></div>
    </section>

  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="bottom-nav__item active" data-tab="home">
      <span class="bottom-nav__icon">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      </span>
      <span class="bottom-nav__label">Home</span>
    </button>
    <button class="bottom-nav__item" data-tab="new-match">
      <span class="bottom-nav__icon">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      </span>
      <span class="bottom-nav__label">New</span>
    </button>
    <button class="bottom-nav__item" data-tab="players">
      <span class="bottom-nav__icon">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
      </span>
      <span class="bottom-nav__label">Players</span>
    </button>
    <button class="bottom-nav__item" data-tab="history">
      <span class="bottom-nav__icon">
        <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
      </span>
      <span class="bottom-nav__label">History</span>
    </button>
    <button class="bottom-nav__item" data-tab="stats">
      <span class="bottom-nav__icon">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
      </span>
      <span class="bottom-nav__label">Stats</span>
    </button>
  </nav>

</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal">
    <div class="modal__handle"></div>
    <div class="modal__header">
      <span class="modal__title" id="modal-title"></span>
      <button class="modal__close" id="modal-close-btn" aria-label="Close">‚úï</button>
    </div>
    <div class="modal__body" id="modal-body"></div>
    <div class="modal__footer" id="modal-footer"></div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
(function() {
  'use strict';

  // =============================================
  // CONSTANTS (avatar colors only ‚Äî no localStorage keys)
  // =============================================
  const AVATAR_COLORS = [
    '#e53935','#8e24aa','#1e88e5','#00897b',
    '#f4511e','#6d4c41','#3949ab','#00838f',
    '#558b2f','#6a1b9a'
  ];

  // =============================================
  // I18N ‚Äî TRANSLATIONS
  // =============================================
  const translations = {
    en: {
      // Nav
      'nav.home': 'Home', 'nav.new': 'New', 'nav.players': 'Players',
      'nav.history': 'History', 'nav.stats': 'Stats',
      // Header
      'header.signOut': 'Sign out', 'header.exportData': 'Export data',
      // Welcome
      'home.ready': 'Ready to play?', 'home.trackResults': 'Track your table tennis results',
      'home.newMatch': '+ New Match',
      // Recent matches
      'home.recentMatches': 'Recent Matches', 'home.viewAll': 'View all',
      'home.noMatchesTitle': 'No matches yet', 'home.noMatchesText': 'Log your first game to get started!',
      // Top players
      'home.players': 'Players', 'home.addPlayers': 'Add players',
      'home.noPlayersTitle': 'No players yet', 'home.noPlayersText': 'Add players to start tracking matches',
      'home.topPlayers': 'Top Players', 'home.seeAllStats': 'See all stats',
      // New match
      'match.players': 'Players', 'match.selectPlayer': 'Select player\u2026',
      'match.sets': 'Sets', 'match.addSet': '+ Add Set',
      'match.result': 'Result', 'match.selectAndEnter': 'Select players & enter scores',
      'match.selectDifferent': 'Select different players', 'match.enterScores': 'Enter scores',
      'match.leads': '{name} leads {score}', 'match.tied': 'Tied {score}',
      'match.noteLabel': 'Note (optional)', 'match.notePlaceholder': 'e.g. Friendly game, tournament...',
      'match.save': 'Save Match', 'match.saving': 'Saving\u2026',
      'match.saved': 'Match saved!', 'match.errorSave': 'Could not save match',
      'match.errorBothPlayers': 'Please select both players',
      'match.errorDifferent': 'Players must be different',
      'match.errorOneSet': 'Add at least one set',
      'match.errorSetDraw': 'Set {n}: scores must be different (no draws in table tennis)',
      // Players
      'players.addPlayer': '+ Add Player', 'players.noPlayersTitle': 'No players yet',
      'players.noPlayersText': 'Tap "+ Add Player" to get started',
      'players.matches': '{n} matches', 'players.match1': '1 match',
      // Add player modal
      'addPlayer.title': 'Add Player', 'addPlayer.nameLabel': 'Name',
      'addPlayer.namePlaceholder': 'Enter player name\u2026', 'addPlayer.save': 'Add Player',
      'addPlayer.added': '{name} added!',
      // Player detail
      'playerDetail.matchesPlayed': '{n} matches played', 'playerDetail.matchPlayed1': '1 match played',
      'playerDetail.winRate': 'Win Rate', 'playerDetail.wl': 'W\u2013L',
      'playerDetail.setsWon': 'Sets Won', 'playerDetail.pointsWon': 'Points Won',
      'playerDetail.recentForm': 'Recent Form', 'playerDetail.h2h': 'Head to Head',
      'playerDetail.delete': 'Delete Player',
      'playerDetail.deleteConfirm': 'Delete {name}?',
      'playerDetail.deleteWithMatches': 'This player has {n} match(es). Delete {name} AND all their matches?',
      'playerDetail.deleteNowWithMatches': 'This player now has match history. Delete {name} AND all their matches?',
      'playerDetail.deletedWithMatches': '{name} and their matches deleted',
      'playerDetail.deleted': '{name} deleted',
      'playerDetail.winStreak': '{n} win streak', 'playerDetail.lossStreak': '{n} loss streak',
      // History
      'history.allPlayers': 'All Players', 'history.noMatchesTitle': 'No matches found',
      'history.noMatchesFiltered': 'No matches for this player yet',
      'history.noMatchesAll': 'Log your first match!', 'history.errorLoad': 'Could not load matches',
      // Date groups
      'date.today': 'Today', 'date.yesterday': 'Yesterday',
      // Stats
      'stats.leaderboard': 'Leaderboard', 'stats.noPlayersTitle': 'No players yet',
      'stats.noPlayersText': 'Add players to see the leaderboard',
      'stats.playerStats': "{name}'s Stats", 'stats.back': '\u2190 All',
      // Confirm
      'confirm.title': 'Confirm', 'confirm.delete': 'Delete', 'confirm.cancel': 'Cancel',
      // Toast
      'toast.dataError': 'Could not load data', 'toast.matchDeleted': 'Match deleted',
      'toast.matchDeleteError': 'Could not delete match',
      // Export
      'export.title': 'Export Data', 'export.description': 'Download your data as CSV or JSON files.',
      'export.json': 'Export JSON', 'export.playersCSV': 'Export Players CSV',
      'export.matchesCSV': 'Export Matches CSV',
      'export.jsonDone': 'JSON exported', 'export.playersDone': 'Players CSV exported',
      'export.matchesDone': 'Matches CSV exported',
      // Users
      'users.title': 'Manage Users', 'users.loading': 'Loading...',
      'users.you': '(you)', 'users.resetPw': 'Reset pw',
      'users.deleteBtn': 'Delete', 'users.addUser': 'Add User',
      'users.failedLoad': 'Failed to load users',
      'users.username': 'Username', 'users.password': 'Password', 'users.role': 'Role',
      'users.userRole': 'User', 'users.adminRole': 'Admin',
      'users.create': 'Create', 'users.back': 'Back',
      'users.usernameAndPwRequired': 'Username and password required',
      'users.pwMin4': 'Password must be at least 4 characters',
      'users.created': 'User created',
      'users.deleteConfirm': 'Delete user "{name}"? This cannot be undone.',
      'users.deleted': 'User deleted',
      // Reset password
      'resetPw.title': 'Reset Password', 'resetPw.newPwFor': 'New password for {name}',
      'resetPw.newPwPlaceholder': 'New password', 'resetPw.reset': 'Reset Password',
      'resetPw.done': 'Password reset',
      // Change own password
      'changePw.title': 'Change Password', 'changePw.current': 'Current Password',
      'changePw.new': 'New Password', 'changePw.currentPlaceholder': 'Current password',
      'changePw.newPlaceholder': 'New password', 'changePw.save': 'Change Password',
      'changePw.bothRequired': 'Both fields required', 'changePw.done': 'Password changed',
      // Time
      'time.justNow': 'just now', 'time.mAgo': '{n}m ago', 'time.hAgo': '{n}h ago',
      'time.yesterday': 'Yesterday', 'time.dAgo': '{n}d ago',
      // Offline
      'offline.banner': 'You are offline. Changes will sync when back online.',
      'offline.queued': 'Saved offline ‚Äî will sync later',
      'offline.syncOk': '{n} change(s) synced successfully',
      'offline.syncFail': '{n} change(s) failed to sync',
      'offline.syncMixed': '{ok} synced, {fail} failed',
    },
    de: {
      'nav.home': 'Start', 'nav.new': 'Neu', 'nav.players': 'Spieler',
      'nav.history': 'Verlauf', 'nav.stats': 'Statistik',
      'header.signOut': 'Abmelden', 'header.exportData': 'Daten exportieren',
      'home.ready': 'Bereit zu spielen?', 'home.trackResults': 'Verfolge deine Tischtennis-Ergebnisse',
      'home.newMatch': '+ Neues Spiel',
      'home.recentMatches': 'Letzte Spiele', 'home.viewAll': 'Alle anzeigen',
      'home.noMatchesTitle': 'Noch keine Spiele', 'home.noMatchesText': 'Trage dein erstes Spiel ein!',
      'home.players': 'Spieler', 'home.addPlayers': 'Spieler hinzuf\u00FCgen',
      'home.noPlayersTitle': 'Noch keine Spieler', 'home.noPlayersText': 'F\u00FCge Spieler hinzu, um Spiele zu verfolgen',
      'home.topPlayers': 'Top-Spieler', 'home.seeAllStats': 'Alle Statistiken',
      'match.players': 'Spieler', 'match.selectPlayer': 'Spieler w\u00E4hlen\u2026',
      'match.sets': 'S\u00E4tze', 'match.addSet': '+ Satz hinzuf\u00FCgen',
      'match.result': 'Ergebnis', 'match.selectAndEnter': 'Spieler w\u00E4hlen & Punkte eingeben',
      'match.selectDifferent': 'Verschiedene Spieler w\u00E4hlen', 'match.enterScores': 'Punkte eingeben',
      'match.leads': '{name} f\u00FChrt {score}', 'match.tied': 'Unentschieden {score}',
      'match.noteLabel': 'Notiz (optional)', 'match.notePlaceholder': 'z.B. Freundschaftsspiel, Turnier...',
      'match.save': 'Spiel speichern', 'match.saving': 'Speichern\u2026',
      'match.saved': 'Spiel gespeichert!', 'match.errorSave': 'Spiel konnte nicht gespeichert werden',
      'match.errorBothPlayers': 'Bitte beide Spieler ausw\u00E4hlen',
      'match.errorDifferent': 'Spieler m\u00FCssen unterschiedlich sein',
      'match.errorOneSet': 'Mindestens einen Satz hinzuf\u00FCgen',
      'match.errorSetDraw': 'Satz {n}: Punkte m\u00FCssen unterschiedlich sein (kein Unentschieden)',
      'players.addPlayer': '+ Spieler hinzuf\u00FCgen', 'players.noPlayersTitle': 'Noch keine Spieler',
      'players.noPlayersText': 'Tippe auf "+\u00A0Spieler hinzuf\u00FCgen"',
      'players.matches': '{n} Spiele', 'players.match1': '1 Spiel',
      'addPlayer.title': 'Spieler hinzuf\u00FCgen', 'addPlayer.nameLabel': 'Name',
      'addPlayer.namePlaceholder': 'Spielername eingeben\u2026', 'addPlayer.save': 'Hinzuf\u00FCgen',
      'addPlayer.added': '{name} hinzugef\u00FCgt!',
      'playerDetail.matchesPlayed': '{n} Spiele gespielt', 'playerDetail.matchPlayed1': '1 Spiel gespielt',
      'playerDetail.winRate': 'Siegquote', 'playerDetail.wl': 'S\u2013N',
      'playerDetail.setsWon': 'S\u00E4tze gewonnen', 'playerDetail.pointsWon': 'Punkte gewonnen',
      'playerDetail.recentForm': 'Letzte Form', 'playerDetail.h2h': 'Direktvergleich',
      'playerDetail.delete': 'Spieler l\u00F6schen',
      'playerDetail.deleteConfirm': '{name} l\u00F6schen?',
      'playerDetail.deleteWithMatches': 'Dieser Spieler hat {n} Spiel(e). {name} UND alle Spiele l\u00F6schen?',
      'playerDetail.deleteNowWithMatches': 'Dieser Spieler hat jetzt Spielverlauf. {name} UND alle Spiele l\u00F6schen?',
      'playerDetail.deletedWithMatches': '{name} und alle Spiele gel\u00F6scht',
      'playerDetail.deleted': '{name} gel\u00F6scht',
      'playerDetail.winStreak': '{n} Siegesserie', 'playerDetail.lossStreak': '{n} Niederlagenserie',
      'history.allPlayers': 'Alle Spieler', 'history.noMatchesTitle': 'Keine Spiele gefunden',
      'history.noMatchesFiltered': 'Noch keine Spiele f\u00FCr diesen Spieler',
      'history.noMatchesAll': 'Trage dein erstes Spiel ein!', 'history.errorLoad': 'Spiele konnten nicht geladen werden',
      'date.today': 'Heute', 'date.yesterday': 'Gestern',
      'stats.leaderboard': 'Rangliste', 'stats.noPlayersTitle': 'Noch keine Spieler',
      'stats.noPlayersText': 'F\u00FCge Spieler hinzu, um die Rangliste zu sehen',
      'stats.playerStats': 'Statistik von {name}', 'stats.back': '\u2190 Alle',
      'confirm.title': 'Best\u00E4tigen', 'confirm.delete': 'L\u00F6schen', 'confirm.cancel': 'Abbrechen',
      'toast.dataError': 'Daten konnten nicht geladen werden', 'toast.matchDeleted': 'Spiel gel\u00F6scht',
      'toast.matchDeleteError': 'Spiel konnte nicht gel\u00F6scht werden',
      'export.title': 'Daten exportieren', 'export.description': 'Lade deine Daten als CSV- oder JSON-Dateien herunter.',
      'export.json': 'JSON exportieren', 'export.playersCSV': 'Spieler-CSV exportieren',
      'export.matchesCSV': 'Spiele-CSV exportieren',
      'export.jsonDone': 'JSON exportiert', 'export.playersDone': 'Spieler-CSV exportiert',
      'export.matchesDone': 'Spiele-CSV exportiert',
      'users.title': 'Benutzer verwalten', 'users.loading': 'Laden...',
      'users.you': '(du)', 'users.resetPw': 'PW zur\u00FCcksetzen',
      'users.deleteBtn': 'L\u00F6schen', 'users.addUser': 'Benutzer hinzuf\u00FCgen',
      'users.failedLoad': 'Benutzer konnten nicht geladen werden',
      'users.username': 'Benutzername', 'users.password': 'Passwort', 'users.role': 'Rolle',
      'users.userRole': 'Benutzer', 'users.adminRole': 'Admin',
      'users.create': 'Erstellen', 'users.back': 'Zur\u00FCck',
      'users.usernameAndPwRequired': 'Benutzername und Passwort erforderlich',
      'users.pwMin4': 'Passwort muss mindestens 4 Zeichen haben',
      'users.created': 'Benutzer erstellt',
      'users.deleteConfirm': 'Benutzer "{name}" l\u00F6schen? Dies kann nicht r\u00FCckg\u00E4ngig gemacht werden.',
      'users.deleted': 'Benutzer gel\u00F6scht',
      'resetPw.title': 'Passwort zur\u00FCcksetzen', 'resetPw.newPwFor': 'Neues Passwort f\u00FCr {name}',
      'resetPw.newPwPlaceholder': 'Neues Passwort', 'resetPw.reset': 'Passwort zur\u00FCcksetzen',
      'resetPw.done': 'Passwort zur\u00FCckgesetzt',
      'changePw.title': 'Passwort \u00E4ndern', 'changePw.current': 'Aktuelles Passwort',
      'changePw.new': 'Neues Passwort', 'changePw.currentPlaceholder': 'Aktuelles Passwort',
      'changePw.newPlaceholder': 'Neues Passwort', 'changePw.save': 'Passwort \u00E4ndern',
      'changePw.bothRequired': 'Beide Felder erforderlich', 'changePw.done': 'Passwort ge\u00E4ndert',
      'time.justNow': 'gerade eben', 'time.mAgo': 'vor {n} Min.', 'time.hAgo': 'vor {n} Std.',
      'time.yesterday': 'Gestern', 'time.dAgo': 'vor {n} Tagen',
      'offline.banner': 'Du bist offline. \u00C4nderungen werden bei Verbindung synchronisiert.',
      'offline.queued': 'Offline gespeichert \u2014 wird sp\u00E4ter synchronisiert',
      'offline.syncOk': '{n} \u00C4nderung(en) erfolgreich synchronisiert',
      'offline.syncFail': '{n} \u00C4nderung(en) konnten nicht synchronisiert werden',
      'offline.syncMixed': '{ok} synchronisiert, {fail} fehlgeschlagen',
    }
  };

  function getLang() {
    return localStorage.getItem('lang') || 'en';
  }

  function setLang(lang) {
    localStorage.setItem('lang', lang);
  }

  function t(key, params) {
    const lang = getLang();
    let str = (translations[lang] && translations[lang][key]) || translations.en[key] || key;
    if (params) {
      for (const [k, v] of Object.entries(params)) {
        str = str.replace(new RegExp('\\{' + k + '\\}', 'g'), v);
      }
    }
    return str;
  }

  // =============================================
  // APP STATE (in-memory cache + UI state)
  // =============================================
  const state = {
    currentTab: 'home',
    players: [],
    matches: [],
    newMatch: { player1Id: '', player2Id: '', sets: [{p1: 11, p2: 0}], note: '' },
    historyFilter: '',
    statsFilter: '',
    me: { role: 'user', username: '' },
    isOnline: navigator.onLine,
    pendingSync: 0
  };

  // =============================================
  // API HELPERS
  // =============================================
  async function apiFetch(url, opts = {}) {
    const headers = opts.headers || {};
    if (opts.body) {
      headers['Content-Type'] = 'application/json';
    }
    const res = await fetch(url, { ...opts, headers });
    if (res.status === 401) {
      // Session expired ‚Äî redirect to login
      window.location.href = '/login';
      throw new Error('Session expired');
    }
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const err = new Error(data.error || 'Request failed');
      err.status = res.status;
      throw err;
    }
    return data;
  }

  // =============================================
  // DATA LAYER (cached, populated via API)
  // =============================================
  function loadPlayers() { return state.players; }
  function loadMatches() { return state.matches; }
  function getPlayerById(id) { return state.players.find(p => p.id === id) || null; }

  async function refreshAll() {
    [state.players, state.matches] = await Promise.all([
      apiFetch('/api/players'),
      apiFetch('/api/matches')
    ]);
  }

  async function refreshPlayers() {
    state.players = await apiFetch('/api/players');
  }

  async function refreshMatches() {
    state.matches = await apiFetch('/api/matches');
  }

  // =============================================
  // PLAYER CRUD
  // =============================================
  async function addPlayer(name) {
    try {
      const player = await apiFetch('/api/players', {
        method: 'POST',
        body: JSON.stringify({ name })
      });
      await refreshPlayers();
      return { ok: true, player };
    } catch(e) {
      return { ok: false, error: e.message };
    }
  }

  async function deletePlayer(id, force) {
    try {
      const qs = force ? '?force=true' : '';
      await apiFetch(`/api/players/${id}${qs}`, { method: 'DELETE' });
      await refreshPlayers();
      await refreshMatches();
      return { ok: true };
    } catch(e) {
      return { ok: false, error: e.message, status: e.status };
    }
  }

  // =============================================
  // MATCH CRUD
  // =============================================
  async function addMatch(data) {
    const match = await apiFetch('/api/matches', {
      method: 'POST',
      body: JSON.stringify(data)
    });
    await refreshMatches();
    return match;
  }

  async function deleteMatch(id) {
    await apiFetch(`/api/matches/${id}`, { method: 'DELETE' });
    await refreshMatches();
  }

  // =============================================
  // WINNER LOGIC
  // =============================================
  function countSetWins(sets) {
    return sets.reduce((acc, s) => {
      if (Number(s.p1) > Number(s.p2)) acc.p1++;
      else if (Number(s.p2) > Number(s.p1)) acc.p2++;
      return acc;
    }, { p1: 0, p2: 0 });
  }

  function determineWinner(sets, p1Id, p2Id) {
    const { p1, p2 } = countSetWins(sets);
    if (p1 > p2) return p1Id;
    if (p2 > p1) return p2Id;
    return null;
  }

  // =============================================
  // STATS ENGINE
  // =============================================
  function computeStats(playerId) {
    const matches = loadMatches().filter(
      m => m.player1Id === playerId || m.player2Id === playerId
    );

    let wins = 0, losses = 0, draws = 0, setsWon = 0, setsLost = 0, pointsWon = 0, pointsLost = 0;
    const recentForm = [];

    for (const m of matches) {
      const isP1 = m.player1Id === playerId;
      const won = m.winnerId === playerId;
      const isDraw = !m.winnerId;
      if (isDraw) {
        draws++;
        recentForm.push('D');
      } else if (won) {
        wins++;
        recentForm.push('W');
      } else {
        losses++;
        recentForm.push('L');
      }

      for (const s of (m.sets || [])) {
        const mine = isP1 ? Number(s.p1) : Number(s.p2);
        const theirs = isP1 ? Number(s.p2) : Number(s.p1);
        if (mine > theirs) setsWon++;
        else if (theirs > mine) setsLost++;
        pointsWon += mine;
        pointsLost += theirs;
      }
    }

    const total = wins + losses + draws;
    const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;

    let streak = 0;
    if (recentForm.length > 0 && recentForm[0] !== 'D') {
      const dir = recentForm[0];
      for (const f of recentForm) {
        if (f === dir) streak += (dir === 'W' ? 1 : -1);
        else break;
      }
    }

    return {
      playerId, wins, losses, draws, totalMatches: matches.length,
      winRate, setsWon, setsLost, pointsWon, pointsLost,
      streak, recentForm: recentForm.slice(0, 5)
    };
  }

  function getLeaderboard() {
    return loadPlayers()
      .map(p => ({ player: p, stats: computeStats(p.id) }))
      .sort((a, b) => {
        if (b.stats.winRate !== a.stats.winRate) return b.stats.winRate - a.stats.winRate;
        return b.stats.wins - a.stats.wins;
      });
  }

  function computeH2H(p1Id, p2Id) {
    const matches = loadMatches().filter(m =>
      (m.player1Id === p1Id && m.player2Id === p2Id) ||
      (m.player1Id === p2Id && m.player2Id === p1Id)
    );
    let p1Wins = 0, p2Wins = 0;
    for (const m of matches) {
      if (m.winnerId === p1Id) p1Wins++;
      else if (m.winnerId === p2Id) p2Wins++;
    }
    return { p1Wins, p2Wins, total: matches.length };
  }

  // =============================================
  // HELPERS
  // =============================================
  function esc(str) {
    return String(str ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function avatarColor(name) {
    let h = 0;
    for (const c of String(name)) h = (h * 31 + c.charCodeAt(0)) % AVATAR_COLORS.length;
    return AVATAR_COLORS[Math.abs(h)];
  }

  function mkAvatar(name, size) {
    const el = document.createElement('div');
    el.className = `avatar avatar--${size}`;
    el.style.background = avatarColor(name);
    el.textContent = (name || '?').charAt(0).toUpperCase();
    return el;
  }

  function relativeTime(ts) {
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return t('time.justNow');
    if (mins < 60) return t('time.mAgo', { n: mins });
    const hrs = Math.floor(diff / 3600000);
    if (hrs < 24) return t('time.hAgo', { n: hrs });
    const days = Math.floor(diff / 86400000);
    if (days === 1) return t('time.yesterday');
    if (days < 7) return t('time.dAgo', { n: days });
    const locale = getLang() === 'de' ? 'de' : 'en';
    return new Date(ts).toLocaleDateString(locale, { month: 'short', day: 'numeric' });
  }

  function dateGroup(ts) {
    const d = new Date(ts);
    const today = new Date(); today.setHours(0,0,0,0);
    const mDay = new Date(d); mDay.setHours(0,0,0,0);
    const diff = (today - mDay) / 86400000;
    if (diff === 0) return t('date.today');
    if (diff === 1) return t('date.yesterday');
    const locale = getLang() === 'de' ? 'de' : 'en';
    return d.toLocaleDateString(locale, { weekday: 'long', month: 'short', day: 'numeric' });
  }

  function formatSets(sets) {
    return (sets || []).map(s => `${s.p1}‚Äì${s.p2}`).join(', ');
  }

  // =============================================
  // EXPORT HELPERS
  // =============================================
  function csvEscape(val) {
    if (val === null || val === undefined) return '';
    const str = String(val);
    if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
      return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  }

  function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportPlayersCSV() {
    const players = loadPlayers();
    const rows = ['ID,Name,Created At'];
    for (const p of players) {
      rows.push([csvEscape(p.id), csvEscape(p.name), csvEscape(new Date(p.createdAt).toISOString())].join(','));
    }
    downloadFile(rows.join('\n'), 'tt-tracker-players.csv', 'text/csv;charset=utf-8');
  }

  function exportMatchesCSV() {
    const matches = loadMatches();
    const rows = ['ID,Date,Player 1,Player 2,Sets,Winner,Note'];
    for (const m of matches) {
      const p1 = getPlayerById(m.player1Id);
      const p2 = getPlayerById(m.player2Id);
      const winner = m.winnerId ? (getPlayerById(m.winnerId)?.name || m.winnerId) : 'Draw';
      rows.push([
        csvEscape(m.id),
        csvEscape(new Date(m.date).toISOString()),
        csvEscape(p1?.name || m.player1Id),
        csvEscape(p2?.name || m.player2Id),
        csvEscape(formatSets(m.sets)),
        csvEscape(winner),
        csvEscape(m.note)
      ].join(','));
    }
    downloadFile(rows.join('\n'), 'tt-tracker-matches.csv', 'text/csv;charset=utf-8');
  }

  function exportJSON() {
    const players = loadPlayers();
    const matches = loadMatches().map(m => {
      const p1 = getPlayerById(m.player1Id);
      const p2 = getPlayerById(m.player2Id);
      return {
        ...m,
        player1Name: p1?.name || null,
        player2Name: p2?.name || null,
        winnerName: m.winnerId ? (getPlayerById(m.winnerId)?.name || null) : null
      };
    });
    const data = { exportedAt: new Date().toISOString(), players, matches };
    downloadFile(JSON.stringify(data, null, 2), 'tt-tracker-export.json', 'application/json');
  }

  function showExportModal() {
    showModal({
      title: t('export.title'),
      bodyHTML: `
        <p style="font-size:14px;color:var(--text-muted);margin-bottom:16px">${esc(t('export.description'))}</p>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn--primary" id="export-json-btn">${esc(t('export.json'))}</button>
          <button class="btn btn--secondary" id="export-players-csv-btn">${esc(t('export.playersCSV'))}</button>
          <button class="btn btn--secondary" id="export-matches-csv-btn">${esc(t('export.matchesCSV'))}</button>
        </div>
      `,
      footerHTML: ''
    });
    document.getElementById('export-json-btn').addEventListener('click', () => {
      exportJSON();
      hideModal();
      showToast(t('export.jsonDone'), 'success');
    });
    document.getElementById('export-players-csv-btn').addEventListener('click', () => {
      exportPlayersCSV();
      hideModal();
      showToast(t('export.playersDone'), 'success');
    });
    document.getElementById('export-matches-csv-btn').addEventListener('click', () => {
      exportMatchesCSV();
      hideModal();
      showToast(t('export.matchesDone'), 'success');
    });
  }

  // =============================================
  // NAVIGATION
  // =============================================
  let _navCounter = 0;

  function showLoading() {
    document.getElementById('loading-overlay')?.classList.add('active');
  }

  function hideLoading() {
    document.getElementById('loading-overlay')?.classList.remove('active');
  }

  async function navigateTo(tabId) {
    // Guard against rapid tab switching: each call gets a unique ID.
    // If a newer call starts before this one finishes, this one aborts.
    const navId = ++_navCounter;

    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.bottom-nav__item').forEach(b => b.classList.remove('active'));

    const panel = document.getElementById('tab-' + tabId);
    if (panel) panel.classList.add('active');
    const btn = document.querySelector(`[data-tab="${tabId}"]`);
    if (btn) btn.classList.add('active');

    state.currentTab = tabId;
    document.querySelector('.tab-content').scrollTop = 0;

    showLoading();

    // Fetch fresh data, then render (silently use cached data if offline)
    try {
      await refreshAll();
    } catch(e) {
      if (!state.isOnline) {
        // Offline ‚Äî use cached state, don't show error (banner is already visible)
      } else {
        showToast(t('toast.dataError'), 'error');
        hideLoading();
        return;
      }
    }

    // If a newer navigation was triggered while we were fetching, bail out
    if (navId !== _navCounter) return;

    const fns = {
      'home':      renderHome,
      'new-match': renderNewMatchTab,
      'players':   renderPlayers,
      'history':   renderHistory,
      'stats':     renderStats
    };
    await fns[tabId]?.();

    hideLoading();
  }

  // =============================================
  // MATCH CARD
  // =============================================
  function createMatchCard(match) {
    const p1 = getPlayerById(match.player1Id);
    const p2 = getPlayerById(match.player2Id);
    const p1Name = p1?.name || 'Unknown';
    const p2Name = p2?.name || 'Unknown';
    const { p1: s1, p2: s2 } = countSetWins(match.sets || []);
    const p1Won = match.winnerId === match.player1Id;
    const p2Won = match.winnerId === match.player2Id;

    const card = document.createElement('div');
    card.className = 'match-card';

    card.innerHTML = `
      <div class="match-card__header">
        <div class="match-card__players">
          <span class="match-card__player ${p1Won ? 'match-card__player--winner' : ''}">${esc(p1Name)}</span>
          <span class="match-card__vs">vs</span>
          <span class="match-card__player ${p2Won ? 'match-card__player--winner' : ''}">${esc(p2Name)}</span>
        </div>
        <span class="match-card__score">${s1}‚Äì${s2}</span>
      </div>
      <div class="match-card__sets">${formatSets(match.sets)}</div>
      <div class="match-card__meta">
        <span class="match-card__time">${relativeTime(match.date)}</span>
        ${match.note ? `<span class="match-card__note">${esc(match.note)}</span>` : ''}
      </div>
    `;

    if (state.me.role === 'admin') {
      initSwipeToDelete(card, () => {
        showConfirmModal(t('confirm.title'), async () => {
          try {
            await deleteMatch(match.id);
            showToast(t('toast.matchDeleted'), 'success');
            if (state.currentTab === 'history') await renderHistory();
            else renderHome();
          } catch(e) {
            showToast(t('toast.matchDeleteError'), 'error');
          }
        });
      });
    }

    return card;
  }

  // =============================================
  // SWIPE TO DELETE
  // =============================================
  function initSwipeToDelete(el, onDelete) {
    let startX = 0, startY = 0, active = false;
    const THRESHOLD = 65;

    el.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      active = true;
    }, { passive: true });

    el.addEventListener('touchmove', e => {
      if (!active) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if (Math.abs(dy) > Math.abs(dx)) { active = false; el.style.transform = ''; return; }
      if (dx < 0) el.style.transform = `translateX(${Math.max(dx, -80)}px)`;
    }, { passive: true });

    el.addEventListener('touchend', e => {
      if (!active) return;
      active = false;
      const dx = e.changedTouches[0].clientX - startX;
      el.style.transform = '';
      if (dx < -THRESHOLD) onDelete();
    });
  }

  // =============================================
  // RENDER: HOME
  // =============================================
  function renderHome() {
    renderWelcome();
    renderRecentMatches();
    renderTopPlayers();
  }

  function renderWelcome() {
    document.getElementById('home-welcome').innerHTML = `
      <div class="welcome-card">
        <div class="welcome-card__text">
          <h2>${esc(t('home.ready'))}</h2>
          <p>${esc(t('home.trackResults'))}</p>
        </div>
        <button class="welcome-card__btn" id="welcome-new-btn">${esc(t('home.newMatch'))}</button>
      </div>
    `;
    document.getElementById('welcome-new-btn').addEventListener('click', () => navigateTo('new-match'));
  }

  function renderRecentMatches() {
    const el = document.getElementById('home-recent-matches');
    const matches = loadMatches();

    if (matches.length === 0) {
      el.innerHTML = `
        <div class="section__header"><span class="section__title">${esc(t('home.recentMatches'))}</span></div>
        <div class="empty-state">
          <div class="empty-state__icon">üèì</div>
          <div class="empty-state__title">${esc(t('home.noMatchesTitle'))}</div>
          <div class="empty-state__text">${esc(t('home.noMatchesText'))}</div>
        </div>
      `;
      return;
    }

    const recent = matches.slice(0, 5);
    const frag = document.createDocumentFragment();

    const hdr = document.createElement('div');
    hdr.className = 'section__header';
    hdr.innerHTML = `<span class="section__title">${esc(t('home.recentMatches'))}</span>`;
    if (matches.length > 5) {
      const a = document.createElement('button');
      a.className = 'section__action';
      a.textContent = t('home.viewAll');
      a.addEventListener('click', () => navigateTo('history'));
      hdr.appendChild(a);
    }
    frag.appendChild(hdr);
    recent.forEach(m => frag.appendChild(createMatchCard(m)));

    el.textContent = '';
    el.appendChild(frag);
  }

  function renderTopPlayers() {
    const el = document.getElementById('home-top-players');
    const players = loadPlayers();

    if (players.length === 0) {
      el.innerHTML = `
        <div class="section__header">
          <span class="section__title">${esc(t('home.players'))}</span>
          <button class="section__action" id="home-add-player">${esc(t('home.addPlayers'))}</button>
        </div>
        <div class="empty-state">
          <div class="empty-state__icon">üë•</div>
          <div class="empty-state__title">${esc(t('home.noPlayersTitle'))}</div>
          <div class="empty-state__text">${esc(t('home.noPlayersText'))}</div>
        </div>
      `;
      document.getElementById('home-add-player').addEventListener('click', () => navigateTo('players'));
      return;
    }

    const lb = getLeaderboard().slice(0, 3);
    if (lb.length === 0) { el.innerHTML = ''; return; }

    const rankClass = ['leaderboard__rank--gold','leaderboard__rank--silver','leaderboard__rank--bronze'];
    let html = `
      <div class="section__header">
        <span class="section__title">${esc(t('home.topPlayers'))}</span>
        <button class="section__action" id="home-see-stats">${esc(t('home.seeAllStats'))}</button>
      </div>
      <div class="leaderboard">
    `;
    lb.forEach(({ player, stats }, i) => {
      html += `
        <div class="leaderboard__row">
          <span class="leaderboard__rank ${rankClass[i]||''}">${i+1}</span>
          <span class="leaderboard__name">${esc(player.name)}</span>
          <span class="leaderboard__record">${stats.wins}W ${stats.losses}L</span>
          <span class="leaderboard__winrate">${stats.winRate}%</span>
        </div>
      `;
    });
    html += `</div>`;
    el.innerHTML = html;
    document.getElementById('home-see-stats')?.addEventListener('click', () => navigateTo('stats'));
  }

  // =============================================
  // RENDER: NEW MATCH TAB
  // =============================================
  function renderNewMatchTab() {
    populatePlayerSelects();
    renderSetRows();
    updateResultPreview();
    document.getElementById('match-note').value = state.newMatch.note;
    // Reset save button state (may have been left disabled after a previous save)
    const saveBtn = document.getElementById('save-match-btn');
    saveBtn.disabled = false;
    saveBtn.textContent = t('match.save');
  }

  function populatePlayerSelects() {
    const players = loadPlayers();
    const opts = players.map(p => `<option value="${esc(p.id)}">${esc(p.name)}</option>`).join('');
    const placeholder = `<option value="">${esc(t('match.selectPlayer'))}</option>`;

    const s1 = document.getElementById('player1-select');
    const s2 = document.getElementById('player2-select');
    s1.innerHTML = placeholder + opts;
    s2.innerHTML = placeholder + opts;
    s1.value = state.newMatch.player1Id;
    s2.value = state.newMatch.player2Id;
  }

  function renderSetRows() {
    const container = document.getElementById('sets-container');
    container.innerHTML = '';
    const sets = state.newMatch.sets;

    sets.forEach((s, i) => {
      const row = document.createElement('div');
      row.className = 'set-row';
      row.innerHTML = `
        <span class="set-row__label">S${i+1}</span>
        <input class="set-row__score" type="number" inputmode="numeric" min="0" max="99"
               value="${s.p1}" data-idx="${i}" data-pl="p1">
        <span class="set-row__sep">‚Äì</span>
        <input class="set-row__score" type="number" inputmode="numeric" min="0" max="99"
               value="${s.p2}" data-idx="${i}" data-pl="p2">
        <button class="set-row__remove" data-idx="${i}"
                ${sets.length <= 1 ? 'disabled' : ''} aria-label="Remove">√ó</button>
      `;
      container.appendChild(row);
    });
  }

  function updateResultPreview() {
    const p1Id = document.getElementById('player1-select')?.value || '';
    const p2Id = document.getElementById('player2-select')?.value || '';
    const preview = document.getElementById('result-preview');
    const text = document.getElementById('result-preview-text');
    if (!preview) return;

    if (!p1Id || !p2Id) {
      preview.className = 'result-preview result-preview--neutral';
      text.textContent = t('match.selectAndEnter');
      return;
    }
    if (p1Id === p2Id) {
      preview.className = 'result-preview result-preview--neutral';
      text.textContent = t('match.selectDifferent');
      return;
    }

    const { p1: w1, p2: w2 } = countSetWins(state.newMatch.sets);
    const p1 = getPlayerById(p1Id);
    const p2 = getPlayerById(p2Id);
    const n1 = p1?.name || 'P1';
    const n2 = p2?.name || 'P2';

    if (w1 > w2) {
      preview.className = 'result-preview result-preview--winning';
      text.textContent = t('match.leads', { name: n1, score: `${w1}\u2013${w2}` });
    } else if (w2 > w1) {
      preview.className = 'result-preview result-preview--winning';
      text.textContent = t('match.leads', { name: n2, score: `${w2}\u2013${w1}` });
    } else {
      preview.className = 'result-preview result-preview--neutral';
      text.textContent = w1 === 0 ? t('match.enterScores') : t('match.tied', { score: `${w1}\u2013${w2}` });
    }
  }

  function validateNewMatch() {
    const p1Id = document.getElementById('player1-select').value;
    const p2Id = document.getElementById('player2-select').value;

    if (!p1Id || !p2Id) return t('match.errorBothPlayers');
    if (p1Id === p2Id) return t('match.errorDifferent');
    if (state.newMatch.sets.length === 0) return t('match.errorOneSet');

    for (let i = 0; i < state.newMatch.sets.length; i++) {
      const s = state.newMatch.sets[i];
      const p1s = Number(s.p1), p2s = Number(s.p2);
      if (p1s === p2s) return t('match.errorSetDraw', { n: i + 1 });
    }

    return null; // valid
  }

  async function submitMatch() {
    const err = validateNewMatch();
    if (err) { showToast(err, 'error'); return; }

    const saveBtn = document.getElementById('save-match-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = t('match.saving');

    try {
      await addMatch({
        player1Id: document.getElementById('player1-select').value,
        player2Id: document.getElementById('player2-select').value,
        sets: [...state.newMatch.sets],
        note: document.getElementById('match-note').value
      });
      state.newMatch = { player1Id: '', player2Id: '', sets: [{p1: 11, p2: 0}], note: '' };
      showToast(t('match.saved'), 'success');
      await navigateTo('home');
    } catch(e) {
      showToast(e.message || t('match.errorSave'), 'error');
      saveBtn.disabled = false;
      saveBtn.textContent = t('match.save');
    }
  }

  // =============================================
  // RENDER: PLAYERS
  // =============================================
  function renderPlayers() {
    const el = document.getElementById('players-list');
    const players = loadPlayers();

    if (players.length === 0) {
      el.innerHTML = `
        <div class="empty-state">
          <div class="empty-state__icon">üë•</div>
          <div class="empty-state__title">${esc(t('players.noPlayersTitle'))}</div>
          <div class="empty-state__text">${esc(t('players.noPlayersText'))}</div>
        </div>
      `;
      return;
    }

    el.innerHTML = '';
    [...players].sort((a, b) => a.name.localeCompare(b.name)).forEach(player => {
      const stats = computeStats(player.id);
      const row = document.createElement('div');
      row.className = 'player-row';

      const avatar = mkAvatar(player.name, 'md');
      row.appendChild(avatar);

      const matchLabel = stats.totalMatches === 1 ? t('players.match1') : t('players.matches', { n: stats.totalMatches });
      const info = document.createElement('div');
      info.className = 'player-row__info';
      info.innerHTML = `
        <div class="player-row__name">${esc(player.name)}</div>
        <div class="player-row__record">${stats.wins}W &nbsp;${stats.losses}L &nbsp;&bull;&nbsp;${esc(matchLabel)}</div>
      `;
      row.appendChild(info);

      const chevron = document.createElement('span');
      chevron.className = 'player-row__chevron';
      chevron.textContent = '‚Ä∫';
      row.appendChild(chevron);

      row.addEventListener('click', () => showPlayerDetailModal(player.id));
      el.appendChild(row);
    });
  }

  function showAddPlayerModal() {
    showModal({
      title: t('addPlayer.title'),
      bodyHTML: `
        <div class="form-group">
          <label class="form-label" for="new-player-name">${esc(t('addPlayer.nameLabel'))}</label>
          <input type="text" class="form-input" id="new-player-name"
                 placeholder="${esc(t('addPlayer.namePlaceholder'))}" maxlength="30" autocomplete="off">
        </div>
      `,
      footerHTML: `<button class="btn btn--primary" id="modal-save-player">${esc(t('addPlayer.save'))}</button>`
    });

    const input = document.getElementById('new-player-name');
    setTimeout(() => input.focus(), 50);

    const save = async () => {
      const btn = document.getElementById('modal-save-player');
      btn.disabled = true;
      const res = await addPlayer(input.value);
      btn.disabled = false;
      if (!res.ok) { showToast(res.error, 'error'); return; }
      hideModal();
      showToast(t('addPlayer.added', { name: res.player.name }), 'success');
      renderPlayers();
      if (state.currentTab === 'home') renderHome();
    };

    document.getElementById('modal-save-player').addEventListener('click', save);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') save(); });
  }

  function showPlayerDetailModal(playerId) {
    const player = getPlayerById(playerId);
    if (!player) return;
    const stats = computeStats(playerId);

    const formBadges = stats.recentForm.map(f =>
      `<span class="form-badge form-badge--${f==='W'?'win':f==='L'?'loss':'draw'}">${f}</span>`
    ).join('');

    let streakHTML = '';
    if (stats.streak !== 0) {
      const w = stats.streak > 0;
      const streakKey = w ? 'playerDetail.winStreak' : 'playerDetail.lossStreak';
      streakHTML = `<span class="streak-badge streak-badge--${w?'win':'loss'}" style="margin-top:6px;display:inline-flex">
        ${w?'üî•':'‚ùÑÔ∏è'} ${esc(t(streakKey, { n: Math.abs(stats.streak) }))}
      </span>`;
    }

    const matchesPlayedText = stats.totalMatches === 1 ? t('playerDetail.matchPlayed1') : t('playerDetail.matchesPlayed', { n: stats.totalMatches });

    const opponents = loadPlayers().filter(p => p.id !== playerId);
    const h2hRows = opponents.map(opp => {
      const h = computeH2H(playerId, opp.id);
      if (h.total === 0) return '';
      return `<div class="h2h-row">
        <span class="h2h-row__name">${esc(opp.name)}</span>
        <span class="h2h-row__record">${h.p1Wins}W ‚Äì ${h.p2Wins}L</span>
      </div>`;
    }).filter(Boolean).join('');

    const avatarHTML = mkAvatar(player.name, 'lg').outerHTML;

    showModal({
      title: player.name,
      bodyHTML: `
        <div class="player-detail__header">
          ${avatarHTML}
          <div>
            <div class="player-detail__name">${esc(player.name)}</div>
            <div class="player-detail__matches">${esc(matchesPlayedText)}</div>
            ${streakHTML}
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-card__value">${stats.winRate}%</div><div class="stat-card__label">${esc(t('playerDetail.winRate'))}</div></div>
          <div class="stat-card"><div class="stat-card__value">${stats.wins}\u2013${stats.losses}</div><div class="stat-card__label">${esc(t('playerDetail.wl'))}</div></div>
          <div class="stat-card"><div class="stat-card__value">${stats.setsWon}</div><div class="stat-card__label">${esc(t('playerDetail.setsWon'))}</div></div>
          <div class="stat-card"><div class="stat-card__value">${stats.pointsWon}</div><div class="stat-card__label">${esc(t('playerDetail.pointsWon'))}</div></div>
        </div>
        ${formBadges ? `
          <div class="section__title" style="margin-bottom:8px">${esc(t('playerDetail.recentForm'))}</div>
          <div class="form-badges" style="margin-bottom:16px">${formBadges}</div>
        ` : ''}
        ${h2hRows ? `
          <div class="section__title" style="margin-bottom:8px">${esc(t('playerDetail.h2h'))}</div>
          <div class="h2h-section">${h2hRows}</div>
        ` : ''}
      `,
      footerHTML: state.me.role === 'admin' ? `<button class="btn btn--danger" id="modal-delete-player">${esc(t('playerDetail.delete'))}</button>` : ''
    });

    if (state.me.role !== 'admin') return;
    document.getElementById('modal-delete-player').addEventListener('click', () => {
      hideModal();
      const hasMatches = playerMatches.length > 0;
      const msg = hasMatches
        ? t('playerDetail.deleteWithMatches', { n: playerMatches.length, name: player.name })
        : t('playerDetail.deleteConfirm', { name: player.name });
      showConfirmModal(msg, async () => {
        const res = await deletePlayer(playerId, hasMatches);
        if (!res.ok) {
          if (res.status === 409) {
            showConfirmModal(t('playerDetail.deleteNowWithMatches', { name: player.name }), async () => {
              const res2 = await deletePlayer(playerId, true);
              if (!res2.ok) { showToast(res2.error, 'error'); return; }
              showToast(t('playerDetail.deletedWithMatches', { name: player.name }), 'success');
              renderPlayers();
              if (state.currentTab === 'home') renderHome();
              if (state.currentTab === 'history') renderHistory();
            });
            return;
          }
          showToast(res.error, 'error');
          return;
        }
        showToast(hasMatches ? t('playerDetail.deletedWithMatches', { name: player.name }) : t('playerDetail.deleted', { name: player.name }), 'success');
        renderPlayers();
        if (state.currentTab === 'home') renderHome();
        if (state.currentTab === 'history') renderHistory();
      });
    });
  }

  // =============================================
  // RENDER: HISTORY
  // =============================================
  async function renderHistory() {
    const sel = document.getElementById('history-filter-select');
    populateFilter(sel, state.historyFilter, t('history.allPlayers'));

    const el = document.getElementById('history-list');

    // Use server-side filtering when a player filter is active
    let matches;
    if (state.historyFilter) {
      try {
        matches = await apiFetch(`/api/matches?player=${encodeURIComponent(state.historyFilter)}`);
      } catch(e) {
        showToast(t('history.errorLoad'), 'error');
        matches = [];
      }
    } else {
      matches = loadMatches();
    }

    if (matches.length === 0) {
      el.innerHTML = `
        <div class="empty-state">
          <div class="empty-state__icon">üìã</div>
          <div class="empty-state__title">${esc(t('history.noMatchesTitle'))}</div>
          <div class="empty-state__text">${esc(state.historyFilter ? t('history.noMatchesFiltered') : t('history.noMatchesAll'))}</div>
        </div>
      `;
      return;
    }

    el.innerHTML = '';
    const groups = new Map();
    for (const m of matches) {
      const key = dateGroup(m.date);
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(m);
    }

    for (const [label, grpMatches] of groups) {
      const hdr = document.createElement('div');
      hdr.className = 'date-group__header';
      hdr.textContent = label;
      el.appendChild(hdr);
      grpMatches.forEach(m => el.appendChild(createMatchCard(m)));
    }
  }

  // =============================================
  // RENDER: STATS
  // =============================================
  function renderStats() {
    const sel = document.getElementById('stats-filter-select');
    populateFilter(sel, state.statsFilter, t('stats.leaderboard'));

    if (state.statsFilter) {
      document.getElementById('leaderboard-container').innerHTML = '';
      renderPlayerStats(state.statsFilter);
    } else {
      renderLeaderboard();
      document.getElementById('player-stats-container').innerHTML = '';
    }
  }

  function renderLeaderboard() {
    const el = document.getElementById('leaderboard-container');
    const lb = getLeaderboard();

    if (lb.length === 0) {
      el.innerHTML = `
        <div class="empty-state">
          <div class="empty-state__icon">üèÜ</div>
          <div class="empty-state__title">${esc(t('stats.noPlayersTitle'))}</div>
          <div class="empty-state__text">${esc(t('stats.noPlayersText'))}</div>
        </div>
      `;
      return;
    }

    const rankClass = ['leaderboard__rank--gold','leaderboard__rank--silver','leaderboard__rank--bronze'];
    let html = `<div class="leaderboard">`;
    lb.forEach(({ player, stats }, i) => {
      html += `
        <div class="leaderboard__row" data-pid="${esc(player.id)}">
          <span class="leaderboard__rank ${rankClass[i]||''}">${i+1}</span>
          <span class="leaderboard__name">${esc(player.name)}</span>
          <span class="leaderboard__record">${stats.wins}W ${stats.losses}L</span>
          <span class="leaderboard__winrate">${stats.winRate}%</span>
        </div>
      `;
    });
    html += `</div>`;
    el.innerHTML = html;

    el.querySelectorAll('.leaderboard__row').forEach(row => {
      row.addEventListener('click', () => {
        state.statsFilter = row.dataset.pid;
        const sel = document.getElementById('stats-filter-select');
        sel.value = state.statsFilter;
        renderStats();
      });
    });
  }

  function renderPlayerStats(playerId) {
    const el = document.getElementById('player-stats-container');
    const player = getPlayerById(playerId);
    if (!player) { el.innerHTML = ''; return; }

    const stats = computeStats(playerId);

    const formBadges = stats.recentForm.map(f =>
      `<span class="form-badge form-badge--${f==='W'?'win':f==='L'?'loss':'draw'}">${f}</span>`
    ).join('');

    let streakHTML = '';
    if (stats.streak !== 0) {
      const w = stats.streak > 0;
      const streakKey = w ? 'playerDetail.winStreak' : 'playerDetail.lossStreak';
      streakHTML = `<div style="margin-bottom:12px"><span class="streak-badge streak-badge--${w?'win':'loss'}">
        ${w?'üî•':'‚ùÑÔ∏è'} ${esc(t(streakKey, { n: Math.abs(stats.streak) }))}
      </span></div>`;
    }

    const opponents = loadPlayers().filter(p => p.id !== playerId);
    const h2hRows = opponents.map(opp => {
      const h = computeH2H(playerId, opp.id);
      if (h.total === 0) return '';
      return `<div class="h2h-row">
        <span class="h2h-row__name">${esc(opp.name)}</span>
        <span class="h2h-row__record">${h.p1Wins}W ‚Äì ${h.p2Wins}L</span>
      </div>`;
    }).filter(Boolean).join('');

    el.innerHTML = `
      <div class="section__header">
        <span class="section__title">${esc(t('stats.playerStats', { name: player.name }))}</span>
        <button class="section__action" id="stats-back">${esc(t('stats.back'))}</button>
      </div>
      ${streakHTML}
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-card__value">${stats.winRate}%</div><div class="stat-card__label">${esc(t('playerDetail.winRate'))}</div></div>
        <div class="stat-card"><div class="stat-card__value">${stats.wins}\u2013${stats.losses}</div><div class="stat-card__label">${esc(t('playerDetail.wl'))}</div></div>
        <div class="stat-card"><div class="stat-card__value">${stats.setsWon}</div><div class="stat-card__label">${esc(t('playerDetail.setsWon'))}</div></div>
        <div class="stat-card"><div class="stat-card__value">${stats.pointsWon}</div><div class="stat-card__label">${esc(t('playerDetail.pointsWon'))}</div></div>
      </div>
      ${formBadges ? `
        <div class="section__title" style="margin-bottom:8px">${esc(t('playerDetail.recentForm'))}</div>
        <div class="form-badges" style="margin-bottom:16px">${formBadges}</div>
      ` : ''}
      ${h2hRows ? `
        <div class="section__title" style="margin-bottom:8px">${esc(t('playerDetail.h2h'))}</div>
        <div class="h2h-section" style="margin-bottom:16px">${h2hRows}</div>
      ` : ''}
    `;

    document.getElementById('stats-back').addEventListener('click', () => {
      state.statsFilter = '';
      document.getElementById('stats-filter-select').value = '';
      renderStats();
    });
  }

  // =============================================
  // FILTER HELPER
  // =============================================
  function populateFilter(sel, currentVal, defaultLabel) {
    const players = loadPlayers();
    sel.innerHTML = `<option value="">${defaultLabel}</option>` +
      players.map(p => `<option value="${esc(p.id)}" ${currentVal===p.id?'selected':''}>${esc(p.name)}</option>`).join('');
    if (currentVal) sel.value = currentVal;
  }

  // =============================================
  // MODAL SYSTEM
  // =============================================
  function showModal({ title, bodyHTML, footerHTML }) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = bodyHTML;
    const footer = document.getElementById('modal-footer');
    footer.innerHTML = footerHTML || '';
    footer.style.display = footerHTML ? '' : 'none';
    document.getElementById('modal-overlay').classList.add('active');
  }

  function hideModal() {
    document.getElementById('modal-overlay').classList.remove('active');
  }

  function showConfirmModal(message, onConfirm) {
    showModal({
      title: t('confirm.title'),
      bodyHTML: `<p style="font-size:15px;line-height:1.6;color:var(--text-muted)">${esc(message)}</p>`,
      footerHTML: `
        <button class="btn btn--danger" id="confirm-yes">${esc(t('confirm.delete'))}</button>
        <button class="btn btn--secondary" id="confirm-no">${esc(t('confirm.cancel'))}</button>
      `
    });
    document.getElementById('confirm-yes').addEventListener('click', () => { hideModal(); onConfirm(); });
    document.getElementById('confirm-no').addEventListener('click', hideModal);
  }

  // =============================================
  // TOAST
  // =============================================
  function showToast(message, type) {
    const el = document.createElement('div');
    el.className = `toast toast--${type || 'info'}`;
    el.textContent = message;
    document.getElementById('toast-container').appendChild(el);
    setTimeout(() => {
      el.classList.add('removing');
      setTimeout(() => el.remove(), 320);
    }, 2500);
  }

  // =============================================
  // GLOBAL EVENT LISTENERS
  // =============================================
  function attachListeners() {
    // Bottom nav
    document.querySelectorAll('.bottom-nav__item').forEach(btn => {
      btn.addEventListener('click', () => navigateTo(btn.dataset.tab));
    });

    // Modal: close button + backdrop
    document.getElementById('modal-close-btn').addEventListener('click', hideModal);
    document.getElementById('modal-overlay').addEventListener('click', e => {
      if (e.target === document.getElementById('modal-overlay')) hideModal();
    });

    // Add player
    document.getElementById('add-player-btn').addEventListener('click', showAddPlayerModal);

    // Add set
    document.getElementById('add-set-btn').addEventListener('click', () => {
      state.newMatch.sets.push({ p1: 11, p2: 0 });
      renderSetRows();
      updateResultPreview();
    });

    // Set score inputs (event delegation)
    document.getElementById('sets-container').addEventListener('input', e => {
      const input = e.target;
      if (!input.classList.contains('set-row__score')) return;
      const idx = parseInt(input.dataset.idx);
      const pl = input.dataset.pl;
      const val = Math.max(0, Math.min(99, parseInt(input.value) || 0));
      input.value = val;
      if (state.newMatch.sets[idx]) {
        state.newMatch.sets[idx][pl] = val;
        updateResultPreview();
      }
    });

    // Remove set (event delegation)
    document.getElementById('sets-container').addEventListener('click', e => {
      const btn = e.target.closest('.set-row__remove');
      if (!btn || btn.disabled) return;
      const idx = parseInt(btn.dataset.idx);
      if (state.newMatch.sets.length > 1) {
        state.newMatch.sets.splice(idx, 1);
        renderSetRows();
        updateResultPreview();
      }
    });

    // Player selects
    document.getElementById('player1-select').addEventListener('change', e => {
      state.newMatch.player1Id = e.target.value;
      updateResultPreview();
    });
    document.getElementById('player2-select').addEventListener('change', e => {
      state.newMatch.player2Id = e.target.value;
      updateResultPreview();
    });

    // Match note (sync to state so it persists across tab switches)
    document.getElementById('match-note').addEventListener('input', e => {
      state.newMatch.note = e.target.value;
    });

    // Save match
    document.getElementById('save-match-btn').addEventListener('click', submitMatch);

    // History filter
    document.getElementById('history-filter-select').addEventListener('change', async (e) => {
      state.historyFilter = e.target.value;
      await renderHistory();
    });

    // Stats filter
    document.getElementById('stats-filter-select').addEventListener('change', e => {
      state.statsFilter = e.target.value;
      renderStats();
    });
  }

  // =============================================
  // USER MANAGEMENT (admin only)
  // =============================================
  async function showUsersModal() {
    showModal({ title: t('users.title'), bodyHTML: `<p style="color:var(--text-muted)">${esc(t('users.loading'))}</p>`, footerHTML: '' });
    try {
      const users = await apiFetch('/api/users');
      let html = '<div style="display:flex;flex-direction:column;gap:10px">';
      for (const u of users) {
        const isSelf = u.username === state.me.username;
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surface-2);border-radius:var(--radius-md)">
          <div>
            <div style="font-weight:600;font-size:14px">${esc(u.username)}</div>
            <div style="font-size:12px;color:var(--text-muted)">${esc(u.role)}${isSelf ? ' ' + esc(t('users.you')) : ''}</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn--secondary" style="padding:6px 10px;font-size:12px;width:auto" onclick="window._resetUserPw('${esc(u.id)}','${esc(u.username)}')">${esc(t('users.resetPw'))}</button>
            ${isSelf ? '' : `<button class="btn btn--danger" style="padding:6px 10px;font-size:12px;width:auto" onclick="window._deleteUser('${esc(u.id)}','${esc(u.username)}')">${esc(t('users.deleteBtn'))}</button>`}
          </div>
        </div>`;
      }
      html += '</div>';
      document.getElementById('modal-body').innerHTML = html;
      const footer = document.getElementById('modal-footer');
      footer.innerHTML = `<button class="btn btn--primary" id="add-user-btn">${esc(t('users.addUser'))}</button>`;
      footer.style.display = '';
      document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
    } catch (e) {
      document.getElementById('modal-body').innerHTML = `<p style="color:var(--danger)">${esc(t('users.failedLoad'))}</p>`;
    }
  }

  function showAddUserModal() {
    showModal({
      title: t('users.addUser'),
      bodyHTML: `
        <div style="display:flex;flex-direction:column;gap:12px">
          <div>
            <label style="display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-muted);margin-bottom:4px">${esc(t('users.username'))}</label>
            <input type="text" id="new-user-name" class="form-input" placeholder="${esc(t('users.username'))}" autocapitalize="off" autocomplete="off">
          </div>
          <div>
            <label style="display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-muted);margin-bottom:4px">${esc(t('users.password'))}</label>
            <input type="password" id="new-user-pass" class="form-input" placeholder="${esc(t('users.password'))}" autocomplete="new-password">
          </div>
          <div>
            <label style="display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-muted);margin-bottom:4px">${esc(t('users.role'))}</label>
            <select id="new-user-role" class="form-select">
              <option value="user">${esc(t('users.userRole'))}</option>
              <option value="admin">${esc(t('users.adminRole'))}</option>
            </select>
          </div>
        </div>
      `,
      footerHTML: `
        <button class="btn btn--primary" id="create-user-btn">${esc(t('users.create'))}</button>
        <button class="btn btn--secondary" id="back-to-users-btn">${esc(t('users.back'))}</button>
      `
    });
    document.getElementById('create-user-btn').addEventListener('click', async () => {
      const username = document.getElementById('new-user-name').value.trim();
      const password = document.getElementById('new-user-pass').value;
      const role = document.getElementById('new-user-role').value;
      if (!username || !password) return showToast(t('users.usernameAndPwRequired'), 'error');
      if (password.length < 4) return showToast(t('users.pwMin4'), 'error');
      try {
        await apiFetch('/api/users', { method: 'POST', body: JSON.stringify({ username, password, role }) });
        showToast(t('users.created'), 'success');
        showUsersModal();
      } catch (e) {
        showToast(e.message, 'error');
      }
    });
    document.getElementById('back-to-users-btn').addEventListener('click', showUsersModal);
  }

  window._resetUserPw = function(userId, username) {
    showModal({
      title: t('resetPw.title'),
      bodyHTML: `
        <p style="font-size:14px;color:var(--text-muted);margin-bottom:12px">${esc(t('resetPw.newPwFor', { name: username }))}</p>
        <input type="password" id="reset-pw-input" class="form-input" placeholder="${esc(t('resetPw.newPwPlaceholder'))}" autocomplete="new-password">
      `,
      footerHTML: `
        <button class="btn btn--primary" id="reset-pw-btn">${esc(t('resetPw.reset'))}</button>
        <button class="btn btn--secondary" id="back-to-users-btn2">${esc(t('users.back'))}</button>
      `
    });
    document.getElementById('reset-pw-btn').addEventListener('click', async () => {
      const password = document.getElementById('reset-pw-input').value;
      if (!password || password.length < 4) return showToast(t('users.pwMin4'), 'error');
      try {
        await apiFetch(`/api/users/${userId}/password`, { method: 'PUT', body: JSON.stringify({ password }) });
        showToast(t('resetPw.done'), 'success');
        showUsersModal();
      } catch (e) {
        showToast(e.message, 'error');
      }
    });
    document.getElementById('back-to-users-btn2').addEventListener('click', showUsersModal);
  };

  window._deleteUser = function(userId, username) {
    showConfirmModal(t('users.deleteConfirm', { name: username }), async () => {
      try {
        await apiFetch(`/api/users/${userId}`, { method: 'DELETE' });
        showToast(t('users.deleted'), 'success');
        showUsersModal();
      } catch (e) {
        showToast(e.message, 'error');
      }
    });
  };

  // =============================================
  // CHANGE OWN PASSWORD
  // =============================================
  function showChangePasswordModal() {
    showModal({
      title: t('changePw.title'),
      bodyHTML: `
        <div style="display:flex;flex-direction:column;gap:12px">
          <div>
            <label style="display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-muted);margin-bottom:4px">${esc(t('changePw.current'))}</label>
            <input type="password" id="cur-pw-input" class="form-input" placeholder="${esc(t('changePw.currentPlaceholder'))}" autocomplete="current-password">
          </div>
          <div>
            <label style="display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-muted);margin-bottom:4px">${esc(t('changePw.new'))}</label>
            <input type="password" id="new-pw-input" class="form-input" placeholder="${esc(t('changePw.newPlaceholder'))}" autocomplete="new-password">
          </div>
        </div>
      `,
      footerHTML: `<button class="btn btn--primary" id="change-pw-btn">${esc(t('changePw.save'))}</button>`
    });
    document.getElementById('change-pw-btn').addEventListener('click', async () => {
      const currentPassword = document.getElementById('cur-pw-input').value;
      const newPassword = document.getElementById('new-pw-input').value;
      if (!currentPassword || !newPassword) return showToast(t('changePw.bothRequired'), 'error');
      if (newPassword.length < 4) return showToast(t('users.pwMin4'), 'error');
      try {
        await apiFetch('/api/me/password', { method: 'PUT', body: JSON.stringify({ currentPassword, newPassword }) });
        showToast(t('changePw.done'), 'success');
        hideModal();
      } catch (e) {
        showToast(e.message, 'error');
      }
    });
  }

  // =============================================
  // INIT
  // =============================================
  // =============================================
  // THEME TOGGLE
  // =============================================
  function getEffectiveTheme() {
    var saved = localStorage.getItem('theme');
    if (saved) return saved;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    if (theme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    } else {
      document.documentElement.removeAttribute('data-theme');
    }
    var btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    // Update meta theme-color
    var meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', theme === 'dark' ? '#1e5c1e' : '#2d7a2d');
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // Theme setup
    applyTheme(getEffectiveTheme());
    document.getElementById('theme-toggle-btn').addEventListener('click', () => {
      var current = getEffectiveTheme();
      var next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (!localStorage.getItem('theme')) applyTheme(getEffectiveTheme());
    });

    // Language toggle
    function updateStaticLabels() {
      // Nav labels
      const navLabels = ['home', 'new-match', 'players', 'history', 'stats'];
      const navKeys  = ['nav.home', 'nav.new', 'nav.players', 'nav.history', 'nav.stats'];
      document.querySelectorAll('.bottom-nav__item').forEach((btn, i) => {
        const label = btn.querySelector('.bottom-nav__label');
        if (label && navKeys[i]) label.textContent = t(navKeys[i]);
      });
      // Sign out button
      const logoutBtn = document.querySelector('form[action="/logout"] button');
      if (logoutBtn) logoutBtn.textContent = t('header.signOut');
      // Static form labels in New Match tab
      const playersLabel = document.querySelector('#tab-new-match .form-label');
      if (playersLabel) playersLabel.textContent = t('match.players');
      const setsLabel = document.querySelectorAll('#tab-new-match .form-label')[1];
      if (setsLabel) setsLabel.textContent = t('match.sets');
      const addSetBtn = document.getElementById('add-set-btn');
      if (addSetBtn) addSetBtn.textContent = t('match.addSet');
      const resultLabel = document.querySelector('.result-preview__label');
      if (resultLabel) resultLabel.textContent = t('match.result');
      const noteLabel = document.querySelector('label[for="match-note"]');
      if (noteLabel) noteLabel.textContent = t('match.noteLabel');
      const noteInput = document.getElementById('match-note');
      if (noteInput) noteInput.placeholder = t('match.notePlaceholder');
      const saveMatchBtn = document.getElementById('save-match-btn');
      if (saveMatchBtn && !saveMatchBtn.disabled) saveMatchBtn.textContent = t('match.save');
      // Players tab button
      const addPlayerBtn = document.getElementById('add-player-btn');
      if (addPlayerBtn) addPlayerBtn.textContent = t('players.addPlayer');
      // Language toggle button text
      const langBtn = document.getElementById('lang-toggle-btn');
      if (langBtn) langBtn.textContent = getLang().toUpperCase();
    }

    const langBtn = document.getElementById('lang-toggle-btn');
    langBtn.textContent = getLang().toUpperCase();
    langBtn.addEventListener('click', () => {
      const next = getLang() === 'en' ? 'de' : 'en';
      setLang(next);
      updateStaticLabels();
      // Re-render active tab
      const fns = {
        'home': renderHome, 'new-match': renderNewMatchTab,
        'players': renderPlayers, 'history': renderHistory, 'stats': renderStats
      };
      fns[state.currentTab]?.();
    });

    // ‚îÄ‚îÄ‚îÄ Offline/Online Detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateOfflineBanner() {
      const banner = document.getElementById('offline-banner');
      if (state.isOnline) {
        banner.classList.remove('active');
      } else {
        banner.textContent = t('offline.banner');
        banner.classList.add('active');
      }
    }

    function updateSyncBadge() {
      const badge = document.getElementById('sync-badge');
      if (state.pendingSync > 0) {
        badge.textContent = state.pendingSync;
        badge.classList.add('active');
      } else {
        badge.classList.remove('active');
      }
    }

    window.addEventListener('online', () => {
      state.isOnline = true;
      updateOfflineBanner();
      // Auto-sync when back online
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'SYNC_QUEUE' });
      }
    });

    window.addEventListener('offline', () => {
      state.isOnline = false;
      updateOfflineBanner();
    });

    // Service worker message handler
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        const { data } = event;
        if (data.type === 'QUEUED_OFFLINE') {
          state.pendingSync++;
          updateSyncBadge();
          showToast(t('offline.queued'), 'info');
        } else if (data.type === 'SYNC_COMPLETE') {
          const { results } = data;
          state.pendingSync = Math.max(0, state.pendingSync - results.synced - results.failed);
          updateSyncBadge();
          if (results.synced > 0 && results.failed === 0) {
            showToast(t('offline.syncOk', { n: results.synced }), 'success');
          } else if (results.synced === 0 && results.failed > 0) {
            showToast(t('offline.syncFail', { n: results.failed }), 'error');
          } else if (results.synced > 0 && results.failed > 0) {
            showToast(t('offline.syncMixed', { ok: results.synced, fail: results.failed }), 'info');
          }
          // Refresh data after sync
          refreshAll().then(() => {
            const fns = {
              'home': renderHome, 'new-match': renderNewMatchTab,
              'players': renderPlayers, 'history': renderHistory, 'stats': renderStats
            };
            fns[state.currentTab]?.();
          }).catch(() => {});
        }
      });
    }

    updateOfflineBanner();
    updateSyncBadge();

    document.getElementById('export-btn').addEventListener('click', showExportModal);
    attachListeners();
    try {
      const [, me, ver] = await Promise.all([
        refreshAll(),
        apiFetch('/api/me').catch(() => null),
        fetch('/api/version').then(r => r.json()).catch(() => null),
      ]);
      if (me) {
        state.me = me;
        if (me.role === 'admin') {
          document.getElementById('users-btn').style.display = '';
          document.getElementById('users-btn').addEventListener('click', showUsersModal);
        }
      }
      if (ver && ver.sha && ver.sha !== 'dev') {
        const badge = document.getElementById('version-badge');
        badge.textContent = ver.sha.slice(0, 7);
        badge.style.display = '';
      }
    } catch(e) {
      showToast(t('toast.dataError'), 'error');
    }
    renderHome();
    updateStaticLabels();
    hideLoading();

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
  });

})();
</script>
</body>
</html>
